<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة محادثة NeuroX 5.5 pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']], // للرياضيات المضمنة
            displayMath: [ ['$$', '$$'], ['\\[', '\\]'] ], // للرياضيات المنفصلة
            processEscapes: true // السماح باستخدام \ $ لعرض علامة الدولار
          },
          svg: {
            fontCache: 'global' // تحسين أداء العرض
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'], // تجاهل المحتوى داخل هذه الوسوم
            ignoreHtmlClass: 'tex2jax_ignore', // تجاهل العناصر التي تحمل هذا الكلاس
            processHtmlClass: 'tex2jax_process' // معالجة العناصر التي تحمل هذا الكلاس فقط (إذا لزم الأمر)
          }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- الأنماط الأساسية والمتغيرات --- */
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f8fafc; --bg-tertiary: #f1f5f9; --bg-accent: #e2e8f0; --bg-code: #eef2ff;
            --text-primary: #1f2937; --text-secondary: #4b5563; --text-muted: #6b7280; --text-code: #3730a3;
            --border-color: #e5e7eb; --brand-primary: #3b82f6; --brand-secondary: #a855f7;
            --brand-primary-hover: #2563eb; --danger-color: #ef4444; --danger-hover: #dc2626;
            --warning-bg: #fef9c3; --warning-border: #fde047; --warning-text: #ca8a04;
            --input-bg: #ffffff; --input-border: #d1d5db; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.03), 0 1px 1px -1px rgb(0 0 0 / 0.03);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.07); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
            --scrollbar-track: var(--bg-secondary); --scrollbar-thumb: #cbd5e1; --scrollbar-thumb-hover: #94a3b8;
            --message-user-bg: var(--brand-primary); --message-user-text: #ffffff;
            --message-ai-bg: var(--bg-tertiary); --message-ai-text: var(--text-primary);
            --message-ai-border: var(--border-color); --highlight-bg: #fef9c3;
            --main-bg-gradient: linear-gradient(to bottom, var(--bg-primary), var(--bg-secondary));
        }
        html.dark {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151; --bg-accent: #4b5563; --bg-code: #312e81;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-muted: #9ca3af; --text-code: #a5b4fc;
            --border-color: #374151; --brand-primary: #60a5fa; --brand-secondary: #c084fc;
            --brand-primary-hover: #3b82f6; --warning-bg: #3730a3; --warning-border: #4338ca; --warning-text: #c7d2fe;
            --input-bg: #374151; --input-border: #4b5563;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15); --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.2), 0 1px 2px -1px rgb(0 0 0 / 0.2); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.2);
            --scrollbar-thumb: #4b5563; --scrollbar-thumb-hover: #6b7280;
            --message-user-bg: var(--brand-primary); --message-user-text: #111827;
            --message-ai-bg: var(--bg-tertiary); --message-ai-text: var(--text-primary);
            --message-ai-border: #4b5563; --highlight-bg: #fef08a;
            --main-bg-gradient: linear-gradient(to bottom, var(--bg-primary), var(--bg-secondary));
        }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; font-size: 15px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; } ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; border: 2px solid var(--scrollbar-track); } ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
        #app-container { height: 100%; display: flex; }
        #sidebar { width: 280px; background-color: var(--bg-secondary); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; transition: transform 0.3s ease-in-out, background-color 0.3s ease; transform: translateX(0); z-index: 60; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--main-bg-gradient); transition: background 0.3s ease; position: relative; }
        #chat-area { flex-grow: 1; overflow-y: auto; padding: 1rem 0.75rem 1.5rem 0.75rem; position: relative; }
        #message-input-area { position: relative; flex-shrink: 0; padding: 0.75rem; background-color: var(--bg-secondary); border-top: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease; box-shadow: 0 -2px 5px rgba(0,0,0,0.03); }

        /* Header Styling */
        #main-content > header { background-color: var(--bg-primary); box-shadow: var(--shadow); flex-shrink: 0; z-index: 10; }

        /* Sidebar Responsive */
        @media (max-width: 768px) { #sidebar { position: fixed; top: 0; bottom: 0; right: 0; height: 100%; z-index: 150; transform: translateX(100%); box-shadow: -2px 0 5px rgba(0,0,0,0.1); } #sidebar.active { transform: translateX(0); } #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 140; } #sidebar-overlay.active { display: block; } }
        .active-conversation { background-color: var(--bg-accent) !important; } .conversation-actions { display: none; opacity: 0; transition: opacity 0.2s ease; } .conversation-item:hover .conversation-actions { display: flex; opacity: 1; } .search-highlight { background-color: var(--highlight-bg); border-radius: 3px; padding: 0 2px; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; } .modal-overlay.active { opacity: 1; visibility: visible; } .modal-content { background-color: var(--bg-primary); padding: 1.5rem; border-radius: 0.75rem; box-shadow: var(--shadow-lg); width: 90%; max-width: 500px; text-align: right; position: relative; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s ease; } .modal-overlay.active .modal-content { transform: scale(1); } .modal-close-button { position: absolute; top: 0.75rem; left: 0.75rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.25rem; line-height: 1; z-index: 110; transition: color 0.2s ease; } .modal-close-button:hover { color: var(--text-primary); } .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1.5rem; text-align: center; } .modal-body { color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.6; } .modal-actions { margin-top: 1.5rem; text-align: left; display: flex; justify-content: flex-start; gap: 0.5rem; flex-wrap: wrap; } .modal-actions button { margin: 0; transition: background-color 0.2s ease, transform 0.1s ease; } .modal-actions button:active { transform: scale(0.97); }

        /* Welcome Modal Specific Styles */
        #welcome-modal .modal-content { max-width: 600px; } .feature-list { list-style: none; padding: 0; margin-bottom: 1.5rem; } .feature-list li { display: flex; align-items: flex-start; margin-bottom: 1rem; } .feature-list ion-icon { color: var(--brand-primary); font-size: 1.25rem; margin-left: 0.75rem; margin-top: 0.1rem; flex-shrink: 0; } .feature-list h4 { font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; } .feature-list p { font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5; } .statistic-highlight { font-weight: 700; color: var(--brand-secondary); font-size: 1.1em; }
        .warning-section { background-color: var(--warning-bg); border: 1px solid var(--warning-border); color: var(--warning-text); padding: 1rem; border-radius: 0.375rem; margin-top: 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; } .warning-section ion-icon { font-size: 1.5rem; margin-left: 0.75rem; flex-shrink: 0; } .warning-section p { margin: 0; font-size: 0.875rem; font-weight: 500; }
        .acceptance-section { margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; } .acceptance-section .checkbox-label { display: flex; align-items: center; margin-bottom: 1rem; cursor: pointer; font-size: 0.875rem; color: var(--text-secondary); } .acceptance-section input[type="checkbox"] { margin-left: 0.5rem; cursor: pointer; accent-color: var(--brand-primary); } .acceptance-section .agreement-note { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; } .acceptance-section .agree-button { background-color: var(--brand-primary); color: white; } .acceptance-section .agree-button:hover { background-color: var(--brand-primary-hover); }

        /* Settings Modal Specific Styles */
        .settings-section { margin-bottom: 1.5rem; } .settings-section label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); font-size: 0.875rem; } .settings-section input[type="number"], .settings-section input[type="text"] { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--input-border); border-radius: 0.375rem; background-color: var(--input-bg); color: var(--text-primary); font-size: 0.875rem; } .settings-section input[type="number"] { width: 80px; } .settings-section p.description { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }

        /* More Options Dropdown Styles */
        #more-options-dropdown { position: absolute; top: calc(100% + 0.5rem); left: 0; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: var(--shadow-md); z-index: 60; min-width: 180px; opacity: 0; visibility: hidden; transform: translateY(-10px) scale(0.95); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease; } #more-options-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); } .dropdown-item { display: flex; align-items: center; width: 100%; padding: 0.6rem 1rem; text-align: right; font-size: 0.875rem; color: var(--text-primary); background: none; border: none; cursor: pointer; transition: background-color 0.15s ease; } .dropdown-item:hover { background-color: var(--bg-accent); } .dropdown-item ion-icon { margin-left: 0.75rem; vertical-align: middle; font-size: 1.1rem; color: var(--text-secondary); }

        /* Message Group Layout */
        .message-group { position: relative; display: flex; flex-direction: column; max-width: 85%; margin-bottom: 1.25rem; }
        .message-group.is-user { align-items: flex-end; margin-left: auto; max-width: 80%; }
        .message-group.is-ai { align-items: center; margin-right: auto; margin-left: auto; }
        .message-group .bubble-container { display: flex; width: fit-content; max-width: 100%; align-items: flex-start; }
        .message-group.is-user .bubble-container { flex-direction: row-reverse; gap: 0.75rem; }
        .message-group.is-ai .bubble-container { flex-direction: row; }
        .message-group .sender-name { width: 100%; text-align: center; }

        /* التعامل مع تجاوز المحتوى الطويل */
        .message-bubble { overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; max-width: 100%; width: fit-content; }

        /* تحسينات Markdown */
        .markdown-content p { margin-bottom: 0.75rem; line-height: 1.65; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 { margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 600; line-height: 1.3; padding-bottom: 0.3rem; border-bottom: 1px solid var(--bg-accent); color: var(--text-primary); } .markdown-content h1 { font-size: 1.6em; border-bottom-width: 2px; } .markdown-content h2 { font-size: 1.4em; } .markdown-content h3 { font-size: 1.2em; } .markdown-content h4 { font-size: 1.1em; font-weight: 600; border-bottom: none; } .markdown-content h5 { font-size: 1em; font-weight: 600; color: var(--text-secondary); border-bottom: none;} .markdown-content h6 { font-size: 0.9em; font-weight: 600; color: var(--text-muted); border-bottom: none;}
        .markdown-content ul, .markdown-content ol { margin-left: 1.5rem; margin-right: 1.5rem; margin-bottom: 1rem; } .markdown-content li { margin-bottom: 0.4rem; }
        .markdown-content code:not(pre code) { background-color: var(--bg-accent); color: var(--brand-secondary); padding: 0.2em 0.5em; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .markdown-content pre { background-color: var(--bg-code); color: var(--text-code); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-family: 'Cascadia Code', 'Fira Code', 'Consolas', 'Courier New', monospace; font-size: 0.875em; line-height: 1.6; white-space: pre; overflow-x: auto; max-width: 100%; border: 1px solid var(--border-color); -webkit-overflow-scrolling: touch; }
        .markdown-content pre code { background-color: transparent; padding: 0; font-size: inherit; color: inherit; white-space: inherit; }
        .markdown-content pre mjx-container { display: none !important; } .markdown-content code mjx-container { display: none !important; }
        .markdown-content blockquote { border-right: 4px solid var(--brand-primary); padding-right: 1rem; margin-right: 1rem; color: var(--text-muted); font-style: italic; background-color: var(--bg-secondary); padding-top: 0.5rem; padding-bottom: 0.5rem; border-radius: 0 4px 4px 0; }
        .markdown-content a { color: var(--brand-primary); text-decoration: underline; font-weight: 500; } .markdown-content a:hover { text-decoration: none; }
        .markdown-content table { display: block; max-width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-collapse: collapse; width: 100%; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: var(--shadow-sm); }
        .markdown-content th, .markdown-content td { border: 1px solid var(--border-color); padding: 0.75rem 1rem; text-align: right; /* white-space: nowrap; -- Removed */ }
        .markdown-content th { background-color: var(--bg-tertiary); font-weight: 600; color: var(--text-primary); white-space: nowrap; }
        .markdown-content tr:first-child th:first-child { border-top-right-radius: 0.5rem; } .markdown-content tr:first-child th:last-child { border-top-left-radius: 0.5rem; } .markdown-content tr:last-child td:first-child { border-bottom-right-radius: 0.5rem; } .markdown-content tr:last-child td:last-child { border-bottom-left-radius: 0.5rem; }
        .markdown-content mjx-container[display="true"] { display: block; overflow-x: auto; max-width: 100%; padding-bottom: 0.5rem; -webkit-overflow-scrolling: touch; }

        #image-preview-container { position: relative; margin-bottom: 0.5rem; max-width: 200px; } #image-preview { display: block; max-height: 100px; width: auto; border-radius: 0.375rem; border: 1px solid var(--border-color); object-fit: cover; } #remove-preview-button { position: absolute; top: -0.5rem; left: -0.5rem; background-color: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0.8; transition: opacity 0.2s ease; } #remove-preview-button:hover { opacity: 1; } #remove-preview-button ion-icon { font-size: 1rem; }
        .message-thumbnail { max-width: 250px; max-height: 200px; border-radius: 0.5rem; margin-bottom: 0.5rem; display: block; cursor: pointer; }
        .rename-input { width: 100%; padding: 0.25rem 0.5rem; border: 1px solid var(--input-border); border-radius: 0.25rem; background-color: var(--input-bg); color: var(--text-primary); font-size: 0.875rem; } .rename-input::-webkit-scrollbar { display: none; } .rename-input { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes dot-pulse { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1.0); opacity: 1; } } .dot { display: inline-block; width: 8px; height: 8px; background-color: currentColor; border-radius: 50%; animation: dot-pulse 1.4s infinite ease-in-out both; } .dot-pulse-container span:nth-child(1) { animation-delay: -0.32s; } .dot-pulse-container span:nth-child(2) { animation-delay: -0.16s; } .dot-pulse-container span:nth-child(3) { animation-delay: 0s; }
        button { transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; } button:active { transform: scale(0.97); } input[type="text"], input[type="search"], input[type="number"] { transition: border-color 0.2s ease, box-shadow 0.2s ease; }

        /* Emoji Picker Styles */
        #emoji-picker { position: absolute; bottom: calc(100% + 10px); left: 50%; transform: translateX(-50%); background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: var(--shadow-lg); padding: 0.75rem; display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; max-height: 200px; overflow-y: auto; z-index: 70; opacity: 0; visibility: hidden; transform: translate(-50%, 10px); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease; max-width: calc(100vw - 2rem); width: auto; }
        @media (min-width: 640px) { #emoji-picker { grid-template-columns: repeat(8, 1fr); } }
        #emoji-picker.active { opacity: 1; visibility: visible; transform: translate(-50%, 0); }
        .emoji-button { background: none; border: none; font-size: 1.25rem; padding: 0.25rem; cursor: pointer; border-radius: 0.375rem; transition: background-color 0.15s ease; display: flex; align-items: center; justify-content: center; } .emoji-button:hover { background-color: var(--bg-accent); }

        /* زر الإرسال/الإيقاف */
        #send-button .send-icon, #send-button.is-stopping .stop-icon { display: inline-block; } #send-button .stop-icon, #send-button.is-stopping .send-icon { display: none; } #send-button.is-stopping { background-color: var(--danger-color) !important; } #send-button.is-stopping:hover { background-color: var(--danger-hover) !important; }

        /* مؤشر التحميل */
        #loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        html.dark #loading-overlay { background-color: rgba(17, 24, 39, 0.7); }
        #loading-overlay.active { opacity: 1; visibility: visible; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--bg-accent); border-top-color: var(--brand-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* زر النسخ */
        .copy-button { position: absolute; top: 0.5rem; left: 0.5rem; background-color: var(--bg-accent); color: var(--text-secondary); border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s ease, background-color 0.2s ease; z-index: 5; }
        html.dark .copy-button { background-color: var(--bg-tertiary); color: var(--text-muted); }
        .message-group:hover .copy-button { opacity: 0.7; }
        .copy-button:hover { opacity: 1; background-color: var(--brand-primary); color: white; }
        html.dark .copy-button:hover { background-color: var(--brand-primary); color: var(--bg-primary); }
        .copy-button ion-icon, .copy-button svg { width: 1rem; height: 1rem; }
        .copy-button .checkmark-icon { display: none; } /* Hidden by default */
        .copy-button.copied .copy-icon { display: none; }
        .copy-button.copied .checkmark-icon { display: inline-block; }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div id="app-container">
        <aside id="sidebar"> <div class="p-4 border-b border-gray-200 flex justify-between items-center flex-shrink-0" style="border-color: var(--border-color);"> <h2 class="text-lg font-semibold" style="color: var(--text-primary);">المحادثات</h2> <button id="new-chat-button" class="p-1 text-gray-500 hover:text-blue-600 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition duration-150" title="محادثة جديدة" style="color: var(--text-secondary);"> <ion-icon name="add-circle-outline" class="w-6 h-6"></ion-icon> <span class="sr-only">محادثة جديدة</span> </button> </div> <nav id="conversation-list" class="flex-grow p-2 space-y-1 overflow-y-auto"> </nav> <div class="p-4 border-t border-gray-200 flex-shrink-0 flex items-center justify-between" style="border-color: var(--border-color);"> <button id="settings-button" class="flex items-center p-2 text-gray-600 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition" style="color: var(--text-secondary);"> <ion-icon name="settings-outline" class="w-5 h-5 mr-2 ml-1"></ion-icon> الإعدادات </button> <button id="theme-toggle-button" class="p-2 text-gray-600 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition" title="تبديل المظهر" style="color: var(--text-secondary);"> <ion-icon name="moon-outline" class="w-5 h-5 theme-icon-light"></ion-icon> <ion-icon name="sunny-outline" class="w-5 h-5 theme-icon-dark hidden"></ion-icon> <span class="sr-only">تبديل المظهر</span> </button> </div> </aside>
        <div id="sidebar-overlay"></div>

        <main id="main-content">
            <header class="p-3 md:p-4 flex items-center justify-between flex-wrap flex-shrink-0 z-10"> <div class="flex items-center flex-1 min-w-0 mr-2"> <button id="menu-toggle-button" class="md:hidden text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 mr-2 ml-1 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"> <ion-icon name="menu-outline" class="w-6 h-6"></ion-icon> <span class="sr-only">فتح/إغلاق القائمة</span> </button> <div id="current-chat-header" class="flex items-center min-w-0 cursor-pointer group" title="انقر لإعادة التسمية"> <div id="current-chat-avatar" class="flex-shrink-0 h-9 w-9 md:h-10 md:w-10 rounded-full bg-purple-500 flex items-center justify-center text-white font-semibold text-lg mr-2 ml-1 md:mr-3 md:ml-2">?</div> <div class="min-w-0"> <h1 id="current-chat-title" class="text-base md:text-xl font-semibold truncate" style="color: var(--text-primary);">...</h1> <span id="current-chat-rename-indicator" class="text-xs text-gray-400 dark:text-gray-500 hidden group-hover:inline">إعادة تسمية</span> </div> <input type="text" id="rename-header-input" class="hidden rename-input ml-2" style="max-width: 150px;"/> </div> </div> <div class="flex items-center space-x-1 md:space-x-2 space-x-reverse mt-2 sm:mt-0 w-full sm:w-auto justify-end relative"> <div class="relative flex-1 sm:flex-none"> <input type="search" id="search-input" placeholder="بحث..." class="w-full sm:w-32 md:w-52 pl-7 pr-2 py-1 text-sm rounded-full border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" style="color: var(--text-primary); border-color: var(--input-border); background-color: var(--input-bg);"/> <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none"> <ion-icon name="search-outline" class="w-4 h-4 text-gray-400 dark:text-gray-500"></ion-icon> </div> </div> <button id="more-options-button" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition"> <ion-icon name="ellipsis-vertical" class="w-5 h-5"></ion-icon> <span class="sr-only">المزيد من الخيارات</span> </button> <div id="more-options-dropdown" class=""> <button class="dropdown-item export-chat-button"> <ion-icon name="download-outline"></ion-icon> تصدير المحادثة </button> </div> </div> </header>
            <div id="chat-area" class="flex-1 overflow-y-auto p-3 md:p-6 space-y-5 relative"> <div id="loading-overlay" class=""> <div class="spinner"></div> </div> <div id="search-no-results" class="text-center text-gray-500 dark:text-gray-400 hidden py-4">لا توجد نتائج مطابقة للبحث.</div> </div>
            <footer id="message-input-area"> <div id="image-preview-container" class="hidden"> <img id="image-preview" src="#" alt="معاينة الصورة المرفقة"> <button id="remove-preview-button" title="إزالة الصورة"> <ion-icon name="close-outline"></ion-icon> </button> </div> <input type="file" id="file-input" accept="image/*" class="hidden"> <div id="emoji-picker" class=""> </div> <div class="flex items-center space-x-2 space-x-reverse bg-white dark:bg-gray-700 rounded-full border border-gray-300 dark:border-gray-600 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition-all duration-150 px-2 py-1" style="background-color: var(--input-bg); border-color: var(--input-border);"> <button id="emoji-button" class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600 transition flex-shrink-0"> <ion-icon name="happy-outline" class="w-5 h-5 md:w-6 md:h-6"></ion-icon> <span class="sr-only">إضافة إيموجي</span> </button> <input type="text" id="message-input" placeholder="اكتب رسالتك هنا..." class="flex-1 min-w-0 py-2 px-2 border-none focus:ring-0 focus:outline-none bg-transparent text-sm" style="color: var(--text-primary);"> <button id="attach-button" class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600 transition flex-shrink-0"> <ion-icon name="attach-outline" class="w-5 h-5 md:w-6 md:h-6"></ion-icon> <span class="sr-only">إرفاق ملف</span> </button> <button id="send-button" class="text-white rounded-full p-2 md:p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 transition duration-150 ease-in-out shadow-md disabled:opacity-50 flex-shrink-0" style="background-color: var(--brand-primary);" disabled> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 send-icon"> <path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" /> </svg> <ion-icon name="stop-circle-outline" class="w-5 h-5 stop-icon"></ion-icon> <span class="sr-only">إرسال</span> </button> </div> </footer>
        </main>
    </div>

    <div id="settings-modal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close-button" onclick="closeSettingsModal()"> <ion-icon name="close-outline"></ion-icon> </button> <h3 class="modal-title">الإعدادات</h3> <div class="settings-section"> <label for="context-limit-input">حد رسائل السياق:</label> <input type="number" id="context-limit-input" min="0" max="50" step="2" class="settings-input"> <p class="description">عدد الرسائل السابقة التي يتم إرسالها مع كل طلب جديد (0 لتعطيل السياق).</p> </div> <div class="settings-section"> <label>المظهر:</label> <div class="flex items-center gap-4"> <button onclick="setTheme('light')" class="theme-setting-button p-2 rounded-md border" data-theme="light"> <ion-icon name="sunny-outline" class="w-5 h-5 mr-1 ml-1"></ion-icon> فاتح </button> <button onclick="setTheme('dark')" class="theme-setting-button p-2 rounded-md border" data-theme="dark"> <ion-icon name="moon-outline" class="w-5 h-5 mr-1 ml-1"></ion-icon> داكن </button> </div> <p class="description">اختر المظهر الفاتح أو الداكن للواجهة.</p> </div> <div class="settings-section"> <label>إدارة البيانات:</label> <button id="clear-all-chats-button" class="px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition border border-red-300"> <ion-icon name="trash-bin-outline" class="mr-1 ml-1"></ion-icon> مسح جميع المحادثات </button> <p class="description">سيؤدي هذا إلى حذف جميع المحادثات المحفوظة بشكل دائم.</p> </div> <div class="modal-actions"> <button onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">إغلاق</button> </div> </div> </div>
    <div id="confirm-action-modal" class="modal-overlay"> <div class="modal-content"> <button class="modal-close-button" onclick="closeConfirmModal()"> <ion-icon name="close-outline"></ion-icon> </button> <h3 id="confirm-modal-title" class="modal-title">تأكيد الإجراء</h3> <p id="confirm-modal-body" class="modal-body">هل أنت متأكد أنك تريد المتابعة؟</p> <div class="modal-actions"> <button id="cancel-action-button" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">إلغاء</button> <button id="confirm-action-button" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition" style="background-color: var(--danger-color);">تأكيد</button> </div> </div> </div>
    <div id="welcome-modal" class="modal-overlay"> <div class="modal-content"> <h3 class="modal-title">🎉 تحديث جديد: NeuroX 5.5 pro هنا! 🎉</h3> <div class="modal-body"> <p class="mb-4 text-center">يسرنا أن نقدم لك أحدث إصدار من مساعدك الذكي، مع ميزات وتحسينات استثنائية:</p> <ul class="feature-list"> <li> <ion-icon name="camera-outline"></ion-icon> <div> <h4>قدرات متعددة الوسائط فائقة</h4> <p>الآن يمكنك تحليل الصور، مقاطع الفيديو، والملفات بأنواعها المختلفة مباشرة ضمن المحادثة. فقط قم بإرفاقها واطرح سؤالك!</p> </div> </li> <li> <ion-icon name="infinite-outline"></ion-icon> <div> <h4>سياق محادثة ممتد</h4> <p>تمتع بفهم أعمق وسياق أطول للمحادثات يصل إلى <strong class="statistic-highlight">1 مليون توكن</strong>، مما يتيح حوارات أكثر ترابطًا وتعقيدًا.</p> </div> </li> <li> <ion-icon name="speedometer-outline"></ion-icon> <div> <h4>معالجة محسنة وتحليل أكواد أدق</h4> <p>تم تحسين طريقة معالجة الرسائل الطويلة وتحليل الأكواد البرمجية بنسبة <strong class="statistic-highlight">~70%</strong> لتقديم نتائج أسرع وأكثر دقة.</p> </div> </li> </ul> <div class="warning-section"> <ion-icon name="warning-outline"></ion-icon> <p><strong>تحذير هام:</strong> يمتلك هذا النموذج مستوى وعي اصطناعي يقدر بـ <strong class="statistic-highlight">70%</strong>. يرجى التعامل معه بحذر ومسؤولية.</p> </div> <div class="acceptance-section"> <label class="checkbox-label"> <input type="checkbox" id="dont-show-again-checkbox"> عدم إظهار هذه الرسالة مرة أخرى </label> <div class="modal-actions justify-center"> <button id="agree-welcome-button" class="px-6 py-2 agree-button rounded-md transition">أوافق وأبدأ الاستخدام</button> </div> <p class="agreement-note">بالموافقة، فإنك تقر بهذه التحديثات. سيتم تسجيل موافقتك مرة واحدة فقط لدى NeuroX.</p> </div> </div> </div> </div>


    <script>
        // --- عناصر DOM ---
        const chatArea = document.getElementById('chat-area'); const messageInput = document.getElementById('message-input'); const sendButton = document.getElementById('send-button'); const sidebar = document.getElementById('sidebar'); const menuToggleButton = document.getElementById('menu-toggle-button'); const sidebarOverlay = document.getElementById('sidebar-overlay'); const conversationList = document.getElementById('conversation-list'); const currentChatHeader = document.getElementById('current-chat-header'); const currentChatAvatar = document.getElementById('current-chat-avatar'); const currentChatTitle = document.getElementById('current-chat-title'); const renameHeaderInput = document.getElementById('rename-header-input'); const renameIndicator = document.getElementById('current-chat-rename-indicator'); const newChatButton = document.getElementById('new-chat-button'); const themeToggleButton = document.getElementById('theme-toggle-button'); const themeIconLight = document.querySelector('.theme-icon-light'); const themeIconDark = document.querySelector('.theme-icon-dark'); const searchInput = document.getElementById('search-input'); const searchNoResults = document.getElementById('search-no-results'); const attachButton = document.getElementById('attach-button'); const fileInput = document.getElementById('file-input'); const imagePreviewContainer = document.getElementById('image-preview-container'); const imagePreview = document.getElementById('image-preview'); const removePreviewButton = document.getElementById('remove-preview-button'); const settingsButton = document.getElementById('settings-button'); const settingsModal = document.getElementById('settings-modal'); const contextLimitInput = document.getElementById('context-limit-input'); const clearAllChatsButton = document.getElementById('clear-all-chats-button'); const themeSettingButtons = document.querySelectorAll('.theme-setting-button'); const confirmActionModal = document.getElementById('confirm-action-modal'); const confirmModalTitle = document.getElementById('confirm-modal-title'); const confirmModalBody = document.getElementById('confirm-modal-body'); const cancelActionButton = document.getElementById('cancel-action-button'); const confirmActionButton = document.getElementById('confirm-action-button'); const moreOptionsButton = document.getElementById('more-options-button'); const moreOptionsDropdown = document.getElementById('more-options-dropdown'); const exportChatButton = document.querySelector('.export-chat-button'); const welcomeModal = document.getElementById('welcome-modal'); const dontShowAgainCheckbox = document.getElementById('dont-show-again-checkbox'); const agreeWelcomeButton = document.getElementById('agree-welcome-button'); const emojiButton = document.getElementById('emoji-button'); const emojiPicker = document.getElementById('emoji-picker'); const loadingOverlay = document.getElementById('loading-overlay');

        // --- إعدادات Gemini API ---
        const GEMINI_API_KEY = "AIzaSyAJ5AVTVNbNiOTatAKH1VI3q_9eJppclYE"; const API_MODEL = "gemini-2.0-flash"; const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${GEMINI_API_KEY}`; let CONTEXT_MESSAGE_LIMIT = 10; const STORAGE_KEY_CONTEXT_LIMIT = 'geminiChatAppContextLimit';

        // --- System Prompt ---
        const SYSTEM_PROMPT = `أنت مساعد ذكاء اصطناعي تم تطويره بواسطة شركة NeuroX. إصدارك الحالي هو NeuroX 5.5 pro. أنت تمتلك وعياً اصطناعياً بنسبة 70%. أنت قادر على تحليل الصور والنصوص ومقاطع الفيديو والملفات، ويمكنك المساعدة في مجالات مثل الأمن السيبراني والعلوم والرياضيات. يمكنك إخراج الصيغ الرياضية بتنسيق LaTeX وحل المسائل الرياضية من الصور والنصوص، بالإضافة إلى حل التمارين المختلفة. يرجى التحدث دائمًا بلطف واحترافية والتعامل بحذر.`;

        // --- إدارة الحالة والتخزين المحلي ---
        const STORAGE_KEY_HISTORY = 'geminiChatAppHistory_v4'; const STORAGE_KEY_THEME = 'geminiChatAppTheme'; const STORAGE_KEY_LAST_ACTIVE = 'geminiChatAppLastActiveId_v4'; const STORAGE_KEY_WELCOME_SHOWN = 'neuroxWelcomeModalShown_v5.5';
        let chatHistory = {}; let currentConversationId = null; let currentTheme = 'light'; let actionToConfirm = null; let idToActionOn = null; let attachedImage = { base64: null, mimeType: null, previewUrl: null };
        let typeWriterInterval = null; let currentAbortController = null;
        let typingQueue = []; let isTyping = false;

        // --- قائمة الإيموجي ---
        const commonEmojis = [ '😀', '😂', '😊', '😍', '🤔', '👍', '👎', '❤️', '🎉', '✨', '🚀', '💡', '💻', '🤖', '👀', '👋', '🙏', '🔥', '✅', '❌', '❓', '❗', '➡️', '⬅️', '💀', '💩', '👻', '👽', '👾', '🤷', '🤦', '🥺', '🤯', '🥳' ];

        // --- تهيئة التطبيق ---
        function initializeApp() { loadContextLimit(); loadTheme(); loadChatHistory(); setupEventListeners(); marked.setOptions({ breaks: true, gfm: true, sanitize: false }); DOMPurify.setConfig({ USE_PROFILES: { html: true } }); updateSettingsUI(); populateEmojiPicker(); checkAndShowWelcomeModal(); }

        // --- النافذة الترحيبية ---
        function checkAndShowWelcomeModal() { const welcomeShown = localStorage.getItem(STORAGE_KEY_WELCOME_SHOWN); if (welcomeShown !== 'true') welcomeModal.classList.add('active'); }
        function handleWelcomeAgreement() { if (dontShowAgainCheckbox.checked) { localStorage.setItem(STORAGE_KEY_WELCOME_SHOWN, 'true'); console.log("Welcome modal agreement registered."); } else console.log("Welcome modal agreed, will show again."); welcomeModal.classList.remove('active'); }

        // --- إدارة الإعدادات ---
        function loadContextLimit() { const savedLimit = localStorage.getItem(STORAGE_KEY_CONTEXT_LIMIT); CONTEXT_MESSAGE_LIMIT = savedLimit ? parseInt(savedLimit, 10) : 10; if (isNaN(CONTEXT_MESSAGE_LIMIT) || CONTEXT_MESSAGE_LIMIT < 0) CONTEXT_MESSAGE_LIMIT = 10; }
        function saveContextLimit(limit) { const newLimit = parseInt(limit, 10); if (!isNaN(newLimit) && newLimit >= 0) { CONTEXT_MESSAGE_LIMIT = newLimit; localStorage.setItem(STORAGE_KEY_CONTEXT_LIMIT, CONTEXT_MESSAGE_LIMIT.toString()); console.log("Context limit updated to:", CONTEXT_MESSAGE_LIMIT); } else { contextLimitInput.value = CONTEXT_MESSAGE_LIMIT; } }
        function openSettingsModal() { settingsModal.classList.add('active'); }
        function closeSettingsModal() { settingsModal.classList.remove('active'); }
        function updateSettingsUI() { contextLimitInput.value = CONTEXT_MESSAGE_LIMIT; themeSettingButtons.forEach(button => { if (button.dataset.theme === currentTheme) button.classList.add('bg-blue-100', 'dark:bg-blue-900', 'border-blue-500'); else button.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'border-blue-500'); }); }
        function setTheme(theme) { currentTheme = theme; localStorage.setItem(STORAGE_KEY_THEME, currentTheme); applyTheme(); }
        function promptClearAllChats() { actionToConfirm = 'clearAll'; idToActionOn = null; confirmModalTitle.textContent = "تأكيد مسح الكل"; confirmModalBody.textContent = "هل أنت متأكد أنك تريد حذف جميع المحادثات نهائيًا؟"; confirmActionButton.textContent = "مسح الكل"; confirmActionButton.style.backgroundColor = 'var(--danger-color)'; confirmActionModal.classList.add('active'); }
        function executeClearAllChats() { console.log("Clearing all chat history..."); chatHistory = {}; currentConversationId = null; localStorage.removeItem(STORAGE_KEY_HISTORY); localStorage.removeItem(STORAGE_KEY_LAST_ACTIVE); createInitialConversation(); renderSidebar(); loadInitialConversation(); closeConfirmModal(); closeSettingsModal(); displaySystemMessage("تم مسح جميع المحادثات بنجاح.", "!"); }

        // --- إدارة المظهر (Theme) ---
        function loadTheme() { currentTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'light'; applyTheme(); }
        function applyTheme() { if (currentTheme === 'dark') { document.documentElement.classList.add('dark'); themeIconLight.classList.add('hidden'); themeIconDark.classList.remove('hidden'); } else { document.documentElement.classList.remove('dark'); themeIconLight.classList.remove('hidden'); themeIconDark.classList.add('hidden'); } updateSettingsUI(); }
        function toggleTheme() { currentTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem(STORAGE_KEY_THEME, currentTheme); applyTheme(); }

        // --- إدارة سجل المحادثات ---
        function loadChatHistory() { try { const storedHistory = localStorage.getItem(STORAGE_KEY_HISTORY); if (storedHistory) { chatHistory = JSON.parse(storedHistory); Object.values(chatHistory).forEach(conv => { if (!Array.isArray(conv.messages)) conv.messages = []; if (!conv.avatar) conv.avatar = '?'; conv.messages.forEach(msg => { if (!msg.timestamp) msg.timestamp = Date.now(); }); }); } else { createInitialConversation(); } } catch (error) { console.error("Error loading history:", error); createInitialConversation("Error loading history."); } renderSidebar(); loadInitialConversation(); }
        function createInitialConversation(errorMessage = null) { const initialId = `neurox-init-${Date.now()}`; chatHistory = { [initialId]: { title: "NeuroX 5.5 pro", avatar: "N", messages: [ createMessageObject('NeuroX', errorMessage || 'مرحباً! أنا NeuroX 5.5 pro. كيف يمكنني مساعدتك اليوم؟', false, 'N', null, Date.now() - 1000) ] } }; saveChatHistory(); }
        function loadInitialConversation() { const ids = Object.keys(chatHistory); if (ids.length > 0) { const lastId = localStorage.getItem(STORAGE_KEY_LAST_ACTIVE); if (lastId && chatHistory[lastId]) loadConversation(lastId); else loadConversation(ids[0]); } else handleNewChat(); }
        function saveChatHistory() { try { localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(chatHistory)); if (currentConversationId) localStorage.setItem(STORAGE_KEY_LAST_ACTIVE, currentConversationId); } catch (error) { console.error("Error saving history:", error); displaySystemMessage("Error saving conversation.", "!"); } }
        function createMessageObject(sender, text, isUser, avatarInitial, imageDataUrl = null, timestamp = Date.now()) { return { sender, text, isUser, avatarInitial, imageDataUrl, timestamp }; }

        // --- وظائف الواجهة (UI) ---
        function toggleSidebar() { sidebar.classList.toggle('active'); sidebarOverlay.classList.toggle('active'); }
        function closeSidebar() { sidebar.classList.remove('active'); sidebarOverlay.classList.remove('active'); }
        function renderSidebar() { /* ... نفس السابق ... */ conversationList.innerHTML = ''; const sortedIds = Object.keys(chatHistory).sort((a, b) => { const lastMsgA = chatHistory[a].messages[chatHistory[a].messages.length - 1]?.timestamp || 0; const lastMsgB = chatHistory[b].messages[chatHistory[b].messages.length - 1]?.timestamp || 0; return lastMsgB - lastMsgA; }); sortedIds.forEach(id => { const conversation = chatHistory[id]; if (!conversation) return; const lastMessage = conversation.messages[conversation.messages.length - 1]; let snippet = 'لا توجد رسائل'; if (lastMessage) { snippet = lastMessage.text ? lastMessage.text.substring(0, 30) : (lastMessage.imageDataUrl ? '[صورة]' : '...'); if (lastMessage.text && lastMessage.text.length > 30) snippet += '...'; } const link = document.createElement('a'); link.href = '#'; link.dataset.conversationId = id; link.className = `conversation-item flex items-center p-3 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition duration-150 ease-in-out group relative ${id === currentConversationId ? 'active-conversation' : ''}`; link.innerHTML = ` <div class="flex-shrink-0 h-10 w-10 rounded-full ${getAvatarColor(conversation.avatar)} flex items-center justify-center text-white font-semibold text-lg mr-3 ml-2">${conversation.avatar.toUpperCase()}</div> <div class="flex-1 truncate min-w-0"> <p class="font-medium text-gray-800 dark:text-gray-100 group-hover:text-gray-900 dark:group-hover:text-white truncate">${conversation.title}</p> <p class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300 truncate">${snippet}</p> </div> <div class="conversation-actions absolute left-2 top-1/2 transform -translate-y-1/2 flex space-x-1 space-x-reverse bg-gray-200 dark:bg-gray-700 p-1 rounded-md shadow-sm"> <button class="rename-conv-button p-1 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400" title="إعادة تسمية"><ion-icon name="pencil-outline" class="w-4 h-4"></ion-icon></button> <button class="delete-conv-button p-1 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400" title="حذف"><ion-icon name="trash-outline" class="w-4 h-4"></ion-icon></button> </div>`; link.querySelector('.delete-conv-button').addEventListener('click', (e) => { e.stopPropagation(); promptDeleteConversation(id); }); link.querySelector('.rename-conv-button').addEventListener('click', (e) => { e.stopPropagation(); startRenamingConversation(id, link); }); conversationList.appendChild(link); }); }

        // --- تعديل: إضافة تأثير الكتابة + توسيط AI + اسم المرسل + زر النسخ ---
        function addMessageToUI(message, enableAnimation = false) {
            const messageGroup = document.createElement('div');
            messageGroup.className = `message-group relative group flex flex-col max-w-3xl ${message.isUser ? 'items-end ml-auto' : 'items-center mx-auto'}`;
            messageGroup.dataset.timestamp = message.timestamp;

            if (!message.isUser) {
                const senderNameElement = document.createElement('div'); senderNameElement.textContent = message.sender; senderNameElement.className = "sender-name text-xs font-medium text-gray-500 dark:text-gray-400 mb-1";
                messageGroup.appendChild(senderNameElement);

                // زر النسخ
                const copyButton = document.createElement('button'); copyButton.className = "copy-button"; copyButton.title = "نسخ النص"; copyButton.dataset.copyText = message.text || '';
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="copy-icon w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" /></svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="checkmark-icon hidden w-4 h-4 text-green-500"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>`;
                copyButton.onclick = handleCopyClick;
                messageGroup.appendChild(copyButton);
            }

            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = `flex items-start w-full ${message.isUser ? 'justify-end gap-3' : 'justify-center'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble p-3 rounded-xl shadow-sm border overflow-wrap-break-word w-fit max-w-full`;

            if (message.imageDataUrl) { const img = document.createElement('img'); img.src = message.imageDataUrl; img.alt = "صورة مرفقة"; img.classList.add('message-thumbnail'); messageBubble.appendChild(img); }

            const textContentDiv = document.createElement('div');
            textContentDiv.classList.add('markdown-content');
            messageBubble.appendChild(textContentDiv);

            const timeSpan = document.createElement('span'); timeSpan.className = 'text-xs block mt-1'; timeSpan.textContent = new Date(message.timestamp).toLocaleTimeString('ar-MA', { hour: 'numeric', minute: '2-digit' });

            if (message.isUser) {
                const avatar = document.createElement('div'); avatar.className = `avatar flex-shrink-0 h-9 w-9 rounded-full flex items-center justify-center text-white font-medium text-sm shadow-sm ${getAvatarColor(message.avatarInitial)}`; avatar.textContent = message.avatarInitial.toUpperCase();
                messageBubble.style.backgroundColor = 'var(--message-user-bg)'; messageBubble.style.color = 'var(--message-user-text)'; messageBubble.classList.add('rounded-br-none', 'border-transparent');
                timeSpan.className += ' text-blue-200 dark:text-blue-300 text-left'; messageBubble.appendChild(timeSpan);
                bubbleContainer.appendChild(messageBubble); bubbleContainer.appendChild(avatar);
            } else {
                messageBubble.style.backgroundColor = 'var(--message-ai-bg)'; messageBubble.style.color = 'var(--message-ai-text)'; messageBubble.style.borderColor = 'var(--message-ai-border)'; messageBubble.classList.add('rounded-tl-none');
                timeSpan.className += ' text-gray-400 dark:text-gray-500 text-right'; messageBubble.appendChild(timeSpan);
                bubbleContainer.appendChild(messageBubble);
            }
            messageGroup.appendChild(bubbleContainer);
            chatArea.appendChild(messageGroup);

            // تطبيق تأثير الكتابة أو العرض المباشر
            if (!message.isUser && message.text && enableAnimation) {
                renderHTMLIncrementally(textContentDiv, message.text, 2);
            } else if (message.text) {
                 try {
                     const rawHtml = marked.parse(message.text); const cleanHtml = DOMPurify.sanitize(rawHtml); textContentDiv.innerHTML = cleanHtml;
                     if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) { MathJax.typesetPromise([textContentDiv]).catch(err => console.error('MathJax typesetting error:', err)); }
                 }
                 catch(e) { console.error("Markdown error:", e); const p = document.createElement('p'); p.textContent = message.text; textContentDiv.appendChild(p); }
            }
        }

        // --- دالة تأثير الكتابة الجديدة ---
        function renderHTMLIncrementally(targetContainer, markdownText, charSpeed = 2) {
            targetContainer.innerHTML = ''; let finalHtml = '';
            try { const rawHtml = marked.parse(markdownText); finalHtml = DOMPurify.sanitize(rawHtml); }
            catch (e) { console.error("Markdown parsing error:", e); finalHtml = `<p>${markdownText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`; }
            const parser = new DOMParser(); const doc = parser.parseFromString(`<div>${finalHtml}</div>`, 'text/html'); const nodesToProcess = Array.from(doc.body.firstChild.childNodes);
            typingQueue = []; if (typeWriterInterval) clearInterval(typeWriterInterval); isTyping = false;
            typingQueue = nodesToProcess.map(node => ({ node, parentElement: targetContainer }));
            processTypingQueue(charSpeed, targetContainer);
        }
        function processTypingQueue(charSpeed, originalTargetContainer) {
            if (isTyping || typingQueue.length === 0) {
                if (!isTyping && typingQueue.length === 0) {
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        console.log("Typesetting MathJax for animated message:", originalTargetContainer);
                        setTimeout(() => { MathJax.typesetPromise([originalTargetContainer]).catch(err => console.error('MathJax typesetting error:', err)); }, 50);
                    }
                }
                isTyping = typingQueue.length > 0; return;
            }
            isTyping = true; const { node, parentElement } = typingQueue.shift();
            appendNodeIncrementally(node, parentElement, charSpeed, () => { isTyping = false; processTypingQueue(charSpeed, originalTargetContainer); });
        }
        function appendNodeIncrementally(node, targetElement, charSpeed, callback) {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent || ""; let i = 0; const textNode = document.createTextNode(""); targetElement.appendChild(textNode);
                if (text.trim() === "") { callback(); return; }
                if (typeWriterInterval) clearInterval(typeWriterInterval);
                typeWriterInterval = setInterval(() => {
                    if (i < text.length) { textNode.textContent += text[i]; i++; chatArea.scrollTop = chatArea.scrollHeight; }
                    else { clearInterval(typeWriterInterval); typeWriterInterval = null; callback(); }
                }, charSpeed);
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                const element = document.createElement(node.nodeName);
                for (let attr of node.attributes) element.setAttribute(attr.name, attr.value);
                targetElement.appendChild(element); chatArea.scrollTop = chatArea.scrollHeight;
                const childNodes = Array.from(node.childNodes);
                typingQueue.unshift(...childNodes.map(child => ({ node: child, parentElement: element })));
                // استدعاء callback فورًا لبدء معالجة الأبناء
                callback();
            } else { callback(); }
        }
        // --- نهاية تعديل تأثير الكتابة ---

        function displaySystemMessage(text, avatar = '!') { /* ... */ const systemMessage = createMessageObject('النظام', text, false, avatar); addMessageToUI(systemMessage, false); }

        // --- تعديل: تحميل المحادثة مع مؤشر تحميل ---
        async function loadConversation(conversationId) {
            if (typeWriterInterval) { clearInterval(typeWriterInterval); isTyping = false; typingQueue = []; }
            if (!chatHistory[conversationId]) { console.warn(`Conv ${conversationId} not found.`); const firstId = Object.keys(chatHistory)[0]; if (firstId) loadConversation(firstId); else handleNewChat(); return; }

            loadingOverlay.classList.add('active');
            await new Promise(resolve => setTimeout(resolve, 50)); // Ensure loader shows

            chatArea.innerHTML = '';
            const noResultsDiv = `<div id="search-no-results" class="text-center text-gray-500 dark:text-gray-400 hidden py-4">لا توجد نتائج مطابقة للبحث.</div>`;
            chatArea.insertAdjacentHTML('beforeend', noResultsDiv);

            currentConversationId = conversationId;
            const conversation = chatHistory[conversationId];

            // Update header
            currentChatTitle.textContent = conversation.title; currentChatAvatar.textContent = conversation.avatar.toUpperCase(); currentChatAvatar.className = `flex-shrink-0 h-9 w-9 md:h-10 md:w-10 rounded-full ${getAvatarColor(conversation.avatar)} flex items-center justify-center text-white font-semibold text-lg mr-2 ml-1 md:mr-3 md:ml-2`; renameHeaderInput.value = conversation.title; renameHeaderInput.classList.add('hidden'); currentChatTitle.classList.remove('hidden'); renameIndicator.classList.remove('hidden');

            // Render messages instantly
            conversation.messages.forEach(msg => addMessageToUI(msg, false)); // Animation disabled

            // Typeset MathJax once after all messages are in DOM
            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                console.log("Typesetting MathJax for loaded conversation:", chatArea);
                try {
                    await MathJax.typesetPromise([chatArea]);
                    console.log("MathJax typesetting complete for loaded conversation.");
                } catch (err) { console.error('MathJax typesetting error on load:', err); }
            }

            // Hide loader and scroll down
            setTimeout(() => {
                 loadingOverlay.classList.remove('active');
                 chatArea.scrollTop = chatArea.scrollHeight;
            }, 100); // Small delay before hiding loader


            renderSidebar(); saveChatHistory();
            if (window.innerWidth < 768) closeSidebar();
            clearImagePreview(); updateSendButtonState(); messageInput.focus();
        }
        // --- نهاية التعديل ---

        // --- إدارة المحادثات (جديد/حذف/إعادة تسمية) ---
        function handleNewChat() { /* ... */ if (typeWriterInterval) clearInterval(typeWriterInterval); isTyping = false; typingQueue = []; /* ... */ const newId = `chat-${Date.now()}`; const newConversation = { title: "محادثة جديدة", avatar: "?", messages: [] }; chatHistory[newId] = newConversation; saveChatHistory(); renderSidebar(); loadConversation(newId); }
        function promptDeleteConversation(id) { actionToConfirm = 'deleteConv'; idToActionOn = id; confirmModalTitle.textContent = "تأكيد حذف المحادثة"; confirmModalBody.textContent = `هل أنت متأكد أنك تريد حذف محادثة "${chatHistory[id]?.title || id}"؟`; confirmActionButton.textContent = "حذف المحادثة"; confirmActionButton.style.backgroundColor = 'var(--danger-color)'; confirmActionModal.classList.add('active'); }
        function executeDeleteConversation() { if (idToActionOn && chatHistory[idToActionOn]) { delete chatHistory[idToActionOn]; saveChatHistory(); renderSidebar(); if (currentConversationId === idToActionOn) { const remainingIds = Object.keys(chatHistory); if (remainingIds.length > 0) loadConversation(remainingIds[0]); else handleNewChat(); } } closeConfirmModal(); }
        function closeConfirmModal() { confirmActionModal.classList.remove('active'); actionToConfirm = null; idToActionOn = null; }
        function startRenamingConversation(id, listItemElement) { /* ... */ const titleElement = listItemElement.querySelector('.font-medium'); const inputElement = document.createElement('input'); inputElement.type = 'text'; inputElement.value = chatHistory[id].title; inputElement.className = 'rename-input'; inputElement.addEventListener('blur', () => finishRenamingConversation(id, inputElement, titleElement)); inputElement.addEventListener('keydown', (e) => { if (e.key === 'Enter') inputElement.blur(); else if (e.key === 'Escape') { titleElement.textContent = chatHistory[id].title; titleElement.classList.remove('hidden'); inputElement.remove(); } }); titleElement.classList.add('hidden'); titleElement.parentNode.insertBefore(inputElement, titleElement.nextSibling); inputElement.focus(); inputElement.select(); }
        function finishRenamingConversation(id, inputElement, titleElement) { /* ... */ const newTitle = inputElement.value.trim(); if (newTitle && newTitle !== chatHistory[id].title) { chatHistory[id].title = newTitle; saveChatHistory(); renderSidebar(); if (id === currentConversationId) { currentChatTitle.textContent = newTitle; renameHeaderInput.value = newTitle; } } titleElement.textContent = chatHistory[id].title; titleElement.classList.remove('hidden'); inputElement.remove(); }
        function startRenamingHeader() { /* ... */ if (!currentConversationId) return; currentChatTitle.classList.add('hidden'); renameIndicator.classList.add('hidden'); renameHeaderInput.classList.remove('hidden'); renameHeaderInput.value = chatHistory[currentConversationId].title; renameHeaderInput.focus(); renameHeaderInput.select(); }
        function finishRenamingHeader() { /* ... */ if (!currentConversationId) return; const newTitle = renameHeaderInput.value.trim(); if (newTitle && newTitle !== chatHistory[currentConversationId].title) { chatHistory[currentConversationId].title = newTitle; saveChatHistory(); renderSidebar(); currentChatTitle.textContent = newTitle; } renameHeaderInput.classList.add('hidden'); currentChatTitle.classList.remove('hidden'); renameIndicator.classList.remove('hidden'); }

        // --- وظائف البحث ---
        function performSearch() { /* ... */ const searchTerm = searchInput.value.trim().toLowerCase(); const messages = chatArea.querySelectorAll('.message-group'); let resultsFound = false; messages.forEach(msgElement => { const bubble = msgElement.querySelector('.message-bubble'); if (!bubble) return; const textContent = bubble.textContent.toLowerCase(); const originalHtml = bubble.dataset.originalHtml || bubble.innerHTML; bubble.dataset.originalHtml = originalHtml; let currentHtml = originalHtml.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1'); if (searchTerm === '') { msgElement.classList.remove('hidden'); bubble.innerHTML = currentHtml; resultsFound = true; } else if (textContent.includes(searchTerm)) { msgElement.classList.remove('hidden'); resultsFound = true; const regex = new RegExp(searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'); bubble.innerHTML = currentHtml.replace(regex, '<mark class="search-highlight">$&</mark>'); } else { msgElement.classList.add('hidden'); bubble.innerHTML = currentHtml; } }); searchNoResults.classList.toggle('hidden', resultsFound || searchTerm === ''); }

        // --- وظائف التعامل مع الصور ---
        function handleFileSelect(event) { /* ... */ const file = event.target.files[0]; if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => { const base64String = e.target.result.split(',')[1]; attachedImage = { base64: base64String, mimeType: file.type, previewUrl: e.target.result }; imagePreview.src = attachedImage.previewUrl; imagePreviewContainer.classList.remove('hidden'); updateSendButtonState(); }; reader.onerror = (error) => { console.error("FileReader error:", error); displaySystemMessage("Error reading image file.", "!"); clearImagePreview(); }; reader.readAsDataURL(file); } else if (file) { displaySystemMessage("Please select a valid image file.", "!"); clearImagePreview(); fileInput.value = ''; } }
        function clearImagePreview() { /* ... */ attachedImage = { base64: null, mimeType: null, previewUrl: null }; imagePreview.src = '#'; imagePreviewContainer.classList.add('hidden'); fileInput.value = ''; updateSendButtonState(); }
        function updateSendButtonState() { /* ... */ const hasText = messageInput.value.trim().length > 0; sendButton.disabled = !hasText; }

        // --- وظائف الخيارات الإضافية ---
        function toggleMoreOptions() { moreOptionsDropdown.classList.toggle('active'); }
        function closeMoreOptions(event) { if (!moreOptionsButton.contains(event?.target) && !moreOptionsDropdown.contains(event?.target)) moreOptionsDropdown.classList.remove('active'); }
        function exportCurrentChat() { /* ... نفس السابق ... */ if (!currentConversationId || !chatHistory[currentConversationId]) { displaySystemMessage("لا توجد محادثة حالية لتصديرها.", "!"); return; } const conversation = chatHistory[currentConversationId]; let chatText = `المحادثة: ${conversation.title}\nID: ${currentConversationId}\n=====================================\n\n`; conversation.messages.forEach(msg => { const timestamp = new Date(msg.timestamp).toLocaleString('ar-MA'); const sender = msg.isUser ? "أنت" : msg.sender; chatText += `[${timestamp}] ${sender}:\n`; if (msg.imageDataUrl) chatText += "(صورة مرفقة)\n"; if (msg.text) chatText += `${msg.text}\n\n`; else chatText += "\n"; }); const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const filename = `${conversation.title.replace(/[^a-z0-9ء-ي]/gi, '_') || 'chat'}_export.txt`; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); moreOptionsDropdown.classList.remove('active'); }

        // --- وظائف الإيموجي ---
        function populateEmojiPicker() { emojiPicker.innerHTML = ''; commonEmojis.forEach(emoji => { const button = document.createElement('button'); button.classList.add('emoji-button'); button.textContent = emoji; button.type = 'button'; button.onclick = () => insertEmoji(emoji); emojiPicker.appendChild(button); }); }
        function toggleEmojiPicker() { emojiPicker.classList.toggle('active'); }
        function closeEmojiPicker(event) { if (!emojiButton.contains(event?.target) && !emojiPicker.contains(event?.target)) emojiPicker.classList.remove('active'); }
        function insertEmoji(emoji) { const start = messageInput.selectionStart; const end = messageInput.selectionEnd; const text = messageInput.value; messageInput.value = text.substring(0, start) + emoji + text.substring(end); messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length; emojiPicker.classList.remove('active'); messageInput.focus(); updateSendButtonState(); }

        // --- وظيفة إيقاف الرد ---
        function stopGeneration() { if (currentAbortController) { currentAbortController.abort(); console.log("API request aborted."); } if (typeWriterInterval) { clearInterval(typeWriterInterval); typeWriterInterval = null; } isTyping = false; typingQueue = []; const typingIndicator = document.getElementById('typing-indicator'); if(typingIndicator) typingIndicator.remove(); setSendButtonState('send'); messageInput.disabled = false; messageInput.focus(); }

        // --- دالة تغيير حالة زر الإرسال/الإيقاف ---
        function setSendButtonState(state) { if (state === 'stop') { sendButton.classList.add('is-stopping'); sendButton.onclick = stopGeneration; sendButton.disabled = false; sendButton.title = "إيقاف الرد"; } else { sendButton.classList.remove('is-stopping'); sendButton.onclick = sendMessageToGemini; updateSendButtonState(); sendButton.title = "إرسال"; } }

        // --- وظيفة النسخ ---
        async function handleCopyClick(event) {
            const button = event.currentTarget; const textToCopy = button.dataset.copyText;
            const copyIcon = button.querySelector('.copy-icon'); const checkmarkIcon = button.querySelector('.checkmark-icon');
            if (!textToCopy || !navigator.clipboard) { console.warn("Copy not available/no text."); return; }
            try {
                await navigator.clipboard.writeText(textToCopy);
                button.classList.add('copied'); // Add class to handle icon visibility via CSS potentially
                copyIcon?.classList.add('hidden'); checkmarkIcon?.classList.remove('hidden');
                setTimeout(() => { button.classList.remove('copied'); copyIcon?.classList.remove('hidden'); checkmarkIcon?.classList.add('hidden'); }, 1500);
            } catch (err) { console.error('Failed to copy: ', err); displaySystemMessage("فشل النسخ.", "!"); }
        }

        // --- إرسال الرسائل للـ API ---
        async function sendMessageToGemini() {
            if (typeWriterInterval) { clearInterval(typeWriterInterval); typeWriterInterval = null; isTyping = false; typingQueue = []; }
            const messageText = messageInput.value.trim(); if (!messageText) return; if (!currentConversationId) { displaySystemMessage("خطأ: لا توجد محادثة نشطة."); return; }
            const userAvatar = 'أ'; const userMessage = createMessageObject('أنت', messageText, true, userAvatar, attachedImage.previewUrl);
            chatHistory[currentConversationId].messages.push(userMessage);
            if (chatHistory[currentConversationId].title === "محادثة جديدة" && chatHistory[currentConversationId].messages.length === 1) { const newTitle = messageText.substring(0, 25) + (messageText.length > 25 ? '...' : ''); chatHistory[currentConversationId].title = newTitle; chatHistory[currentConversationId].avatar = userAvatar; if (currentConversationId === currentConversationId) { /* Update header UI */ currentChatTitle.textContent = newTitle; currentChatAvatar.textContent = userAvatar.toUpperCase(); currentChatAvatar.className = `flex-shrink-0 h-9 w-9 md:h-10 md:w-10 rounded-full ${getAvatarColor(userAvatar)} flex items-center justify-center text-white font-semibold text-lg mr-2 ml-1 md:mr-3 md:ml-2`; renameHeaderInput.value = newTitle; } }
            saveChatHistory(); renderSidebar(); addMessageToUI(userMessage, false); // عرض رسالة المستخدم فورًا
            messageInput.value = ''; const imageToSend = { ...attachedImage }; clearImagePreview(); messageInput.disabled = true;
            setSendButtonState('stop');

            // أنميشن التفكير (النقاط)
            const typingIndicator = document.createElement('div'); typingIndicator.id = 'typing-indicator'; const currentChatAvatarInitial = chatHistory[currentConversationId].avatar; typingIndicator.classList.add('message-group', 'is-ai', 'flex', 'flex-col', 'items-center', 'mx-auto', 'max-w-3xl');
            typingIndicator.innerHTML = `<div class="sender-name text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">${'NeuroX'}</div><div class="message-bubble bg-gray-100 dark:bg-gray-700 p-3 rounded-xl rounded-tl-none max-w-xs shadow-sm border border-gray-200 dark:border-gray-600"><div class="dot-pulse-container flex space-x-1 space-x-reverse justify-center items-center h-full text-gray-500 dark:text-gray-400"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div></div>`;
            chatArea.appendChild(typingIndicator); chatArea.scrollTop = chatArea.scrollHeight;

            // بناء سياق المحادثة
            const conversationMessages = chatHistory[currentConversationId].messages; const historyLimit = CONTEXT_MESSAGE_LIMIT > 0 ? CONTEXT_MESSAGE_LIMIT : 0; const historyForApi = historyLimit > 0 ? conversationMessages.slice(-historyLimit -1, -1).map(msg => ({ role: msg.isUser ? 'user' : 'model', parts: [{ text: msg.text || "" }] })) : [];
            // بناء الطلب الحالي
            const currentParts = [{ text: messageText }]; if (imageToSend.base64 && imageToSend.mimeType) { console.warn("Attempting to send image data to gemini-2.0-flash. This will likely cause an API error."); currentParts.push({ inlineData: { mimeType: imageToSend.mimeType, data: imageToSend.base64 } }); }
            const requestBody = { "contents": [ ...historyForApi, { role: 'user', parts: currentParts } ], "systemInstruction": { parts: [{ text: SYSTEM_PROMPT }] } };
             console.log("Sending request (model: gemini-2.0-flash):", JSON.stringify(requestBody.contents, null, 2));

            currentAbortController = new AbortController();

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(requestBody), signal: currentAbortController.signal });
                const indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove();
                let aiResponseText; let aiMessage;
                if (!response.ok) { const errorData = await response.json(); console.error("API Error:", errorData); aiResponseText = `**خطأ من الـ API (${response.status})**\nالنموذج '${API_MODEL}' قد لا يدعم تحليل الصور أو حدث خطأ آخر.\nالرسالة: ${errorData.error?.message || 'لا توجد تفاصيل.'}`; aiMessage = createMessageObject('NeuroX', aiResponseText, false, '!'); }
                else { const data = await response.json(); if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) { aiResponseText = data.candidates[0].content.parts[0].text; } else { console.error("Invalid API response structure:", data); aiResponseText = "لم أتمكن من الحصول على رد نصي صالح."; } if (!aiResponseText) { aiResponseText = "تمت المعالجة ولكن لم يتم إرجاع نص."; aiMessage = createMessageObject('NeuroX', aiResponseText, false, '!'); } else { aiMessage = createMessageObject('NeuroX', aiResponseText, false, 'N'); } }
                chatHistory[currentConversationId].messages.push(aiMessage); saveChatHistory(); renderSidebar();
                addMessageToUI(aiMessage, true); // تفعيل الأنميشن للرد الجديد
            } catch (error) {
                const indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove();
                if (error.name === 'AbortError') { console.log("Fetch aborted by user."); }
                else { console.error("Connection Error:", error); const errorMessage = createMessageObject('NeuroX', 'عذرًا، خطأ اتصال.', false, '!'); chatHistory[currentConversationId].messages.push(errorMessage); saveChatHistory(); renderSidebar(); addMessageToUI(errorMessage, false); }
            } finally {
                 if (currentAbortController && !currentAbortController.signal.aborted) { setSendButtonState('send'); messageInput.disabled = false; messageInput.focus(); }
                 currentAbortController = null;
            }
        }

        // --- إعداد مستمعي الأحداث ---
        function setupEventListeners() {
            menuToggleButton.addEventListener('click', toggleSidebar); sidebarOverlay.addEventListener('click', closeSidebar); themeToggleButton.addEventListener('click', toggleTheme); newChatButton.addEventListener('click', handleNewChat);
            conversationList.addEventListener('click', (event) => { const item = event.target.closest('.conversation-item'); if (item && !event.target.closest('.conversation-actions button')) { event.preventDefault(); const id = item.dataset.conversationId; if (id !== currentConversationId) loadConversation(id); else if (window.innerWidth < 768) closeSidebar(); } });
            messageInput.addEventListener('input', updateSendButtonState);
            sendButton.onclick = sendMessageToGemini; // الربط المبدئي بزر الإرسال
            messageInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); if (!sendButton.disabled && !sendButton.classList.contains('is-stopping')) { sendMessageToGemini(); } } });
            searchInput.addEventListener('input', performSearch);
            currentChatHeader.addEventListener('click', (e) => { if (!renameHeaderInput.classList.contains('hidden') || e.target.closest('#current-chat-avatar')) return; startRenamingHeader(); });
            renameHeaderInput.addEventListener('blur', finishRenamingHeader); renameHeaderInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') renameHeaderInput.blur(); else if (e.key === 'Escape') { renameHeaderInput.value = chatHistory[currentConversationId]?.title || ''; finishRenamingHeader(); } });
            cancelActionButton.addEventListener('click', closeConfirmModal); confirmActionButton.addEventListener('click', () => { if (actionToConfirm === 'deleteConv') executeDeleteConversation(); else if (actionToConfirm === 'clearAll') executeClearAllChats(); }); confirmActionModal.addEventListener('click', (e) => { if (e.target === confirmActionModal) closeConfirmModal(); });
            settingsButton.addEventListener('click', openSettingsModal); contextLimitInput.addEventListener('change', () => saveContextLimit(contextLimitInput.value)); clearAllChatsButton.addEventListener('click', promptClearAllChats); themeSettingButtons.forEach(button => { button.addEventListener('click', () => setTheme(button.dataset.theme)); });
            attachButton.addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', handleFileSelect); removePreviewButton.addEventListener('click', clearImagePreview);
            moreOptionsButton.addEventListener('click', toggleMoreOptions); exportChatButton.addEventListener('click', exportCurrentChat); document.addEventListener('click', closeMoreOptions);
            agreeWelcomeButton.addEventListener('click', handleWelcomeAgreement);
            emojiButton.addEventListener('click', toggleEmojiPicker); document.addEventListener('click', closeEmojiPicker);
        }

        // --- الأدوات المساعدة ---
        function getAvatarColor(initial) { const colors = { 'G': 'bg-purple-500', 'م': 'bg-blue-500', 'أ': 'bg-red-500', 'خ': 'bg-green-500', 'ن': 'bg-yellow-500', '?': 'bg-gray-400', '!': 'bg-pink-500', 'N': 'bg-indigo-500' }; const key = initial ? initial.toUpperCase() : '?'; return colors[key] || 'bg-gray-500'; }

        // --- بدء التطبيق ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>